<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie UI</title>
    <link rel="stylesheet" href="style/movie.css">
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.3/dist/web3.min.js"></script>
</head>
<body>

    <header>
        <h1>Movie List</h1>
    </header>
    <div class="movie-title">
        <video width="100%" controls>
            <source src="img/title.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>
    <div class="movie-container">
        <!-- Movie 1 -->
        <div class="movie-card">
            <img src="img/1.jpg" alt="Movie 1">
            <div class="movie-details">
                <div class="movie-title">Trunk Locked In</div>
                <div class="movie-description">Description for Movie 1.</div>
                <div class="movie-price" data-price-ether="0.01">0.01 Ether</div>
                <button class="buy-button" data-movie-title="1">Buy Now</button>
            </div>
        </div>

        <!-- Movie 2 -->
        <div class="movie-card">
            <img src="img/2.jpg" alt="Movie 2">
            <div class="movie-details">
                <div class="movie-title">The Beekeeper</div>
                <div class="movie-description">Description for Movie 2.</div>
                <div class="movie-price" data-price-ether="0.02">0.02 Ether</div>
                <button class="buy-button" data-movie-title="2">Buy Now</button>
            </div>
        </div>

        <!-- Movie 3 -->
        <div class="movie-card">
            <img src="img/3.jpg" alt="Movie 3">
            <div class="movie-details">
                <div class="movie-title">Fast and Furious 9</div>
                <div class="movie-description">Description for Movie 3.</div>
                <div class="movie-price" data-price-ether="0.03">0.03 Ether</div>
                <button class="buy-button" data-movie-title="3">Buy Now</button>
            </div>
        </div>

        <!-- Movie 4 -->
        <div class="movie-card">
            <img src="img/4.jpg" alt="Movie 4">
            <div class="movie-details">
                <div class="movie-title">Ant-Man and the Wasp Quantumania</div>
                <div class="movie-description">Description for Movie 4.</div>
                <div class="movie-price" data-price-ether="0.04">0.04 Ether</div>
                <button class="buy-button" data-movie-title="4">Buy Now</button>
            </div>
        </div>

        <!-- Movie 5 -->
        <div class="movie-card">
            <img src="img/5.jpg" alt="Movie 5">
            <div class="movie-details">
                <div class="movie-title">The Tigerâ€™s Apprentice</div>
                <div class="movie-description">Description for Movie 5.</div>
                <div class="movie-price" data-price-ether="0.05">0.05 Ether</div>
                <button class="buy-button" data-movie-title="5">Buy Now</button>
            </div>
        </div>

        <!-- Movie 6 -->
        <div class="movie-card">
            <img src="img/6.jpg" alt="Movie 6">
            <div class="movie-details">
                <div class="movie-title">One Piece</div>
                <div class="movie-description">Description for Movie 6.</div>
                <div class="movie-price" data-price-ether="0.06">0.06 Ether</div>
                <button class="buy-button" data-movie-title="6">Buy Now</button>
            </div>
        </div>

        <!-- Movie 7 -->
        <div class="movie-card">
            <img src="img/7.jpg" alt="Movie 7">
            <div class="movie-details">
                <div class="movie-title">Movie 7</div>
                <div class="movie-description">Description for Movie 7.</div>
                <div class="movie-price" data-price-ether="0.07">0.07 Ether</div>
                <button class="buy-button" data-movie-title="7">Buy Now</button>
            </div>
        </div>

        <!-- Movie 8 -->
        <div class="movie-card">
            <img src="img/8.jpg" alt="Movie 8">
            <div class="movie-details">
                <div class="movie-title">Movie 8</div>
                <div class="movie-description">Description for Movie 8.</div>
                <div class="movie-price" data-price-ether="0.08">0.08 Ether</div>
                <button class="buy-button" data-movie-title="8">Buy Now</button>
            </div>
        </div>

        <!-- Movie 9 -->
        <div class="movie-card">
            <img src="img/9.jpg" alt="Movie 9">
            <div class="movie-details">
                <div class="movie-title">Movie 9</div>
                <div class="movie-description">Description for Movie 9.</div>
                <div class="movie-price" data-price-ether="0.09">0.09 Ether</div>
                <button class="buy-button" data-movie-title="9">Buy Now</button>
            </div>
        </div>

        <!-- Movie 10 -->
        <div class="movie-card">
            <img src="img/10.jpg" alt="Movie 10">
            <div class="movie-details">
                <div class="movie-title">Movie 10</div>
                <div class="movie-description">Description for Movie 10.</div>
                <div class="movie-price" data-price-ether="0.1">0.1 Ether</div>
                <button class="buy-button" data-movie-title="10">Buy Now</button>
            </div>
        </div>
        <div class="ownership-details">
            <h2>Ownership Details</h2>
            <p id="ownership-result"></p>
        </div>       

    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js">
    </script>
    <script>
        let web3;

        async function loadWeb3() {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                
                await ethereum.request({ method: 'eth_requestAccounts' });
            }
        }

        async function loadContract() {
            const abi = [
            [
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "movieTitle",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "bytes32",
				"name": "hash",
				"type": "bytes32"
			}
		],
		"name": "MoviePurchased",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "movieTitle",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "reason",
				"type": "string"
			}
		],
		"name": "PurchaseError",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "movieTitle",
				"type": "string"
			}
		],
		"name": "checkMoviePurchase",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "movieTitle",
				"type": "string"
			}
		],
		"name": "purchaseMovie",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	}
]
            ]; 
            const contractAddress = '0xa3036987e013a3697fcc83565dd643753428b32418b9971927fa7926cb0b6a4a';
            return new web3.eth.Contract(abi, contractAddress);
        }

        async function load() {
            await loadWeb3();
            web3.contract = await loadContract();
            updateStatus('Ready!');
        }

        function updateStatus(status) {
            console.log(status);
        }

        $(document).ready(async function () {
            await load();

            // Add a script to handle the Buy Now button click event
            const buyButtons = $('.buy-button');

            buyButtons.click(async function () {
                try {
                    await window.ethereum.enable();
                    const accounts = await web3.eth.getAccounts();
                    const buyerAddress = accounts[0];

                    // Get the movie ID from the data attribute
                    const movieTitle = $(this).parent().find('.movie-title').text();

                    // Get the Ether price from the data attribute
                    const etherPrice = $(this).parent().find('.movie-price').attr('data-price-ether');

                    // Convert Ether price to Wei
                    const weiPrice = web3.utils.toWei(etherPrice, 'ether');

                    const result = await web3.contract.methods.purchaseMovie(movieTitle).send({
                        from: buyerAddress,
                        value: weiPrice,
                    });

                    console.log(result);

                    // Update UI or show ownership details
                    const ownershipDetails = await web3.contract.methods.checkMoviePurchase(movieTitle).call();
                    console.log('Ownership Details:', ownershipDetails);
                    $('#ownership-result').text(`You are the owner: ${ownershipDetails}`);
                } catch (error) {
                    console.error(error);
                }
            });
        });
    </script>

</body>
</html>